import { createPassword, createUser, getUserImages } from '@tests/db.utils'
import { prisma } from '@/utils/db.server.ts'

async function seed() {
	console.log('ðŸŒ± Seeding...')
	console.time(`ðŸŒ± Database has been seeded`)

	console.time('ðŸ”‘ Created permissions...')
	const entities = ['user']
	const actions = ['create', 'read', 'update', 'delete']
	const accesses = ['own', 'any'] as const

	let permissionsToCreate = []
	for (const entity of entities) {
		for (const action of actions) {
			for (const access of accesses) {
				permissionsToCreate.push({ entity, action, access })
			}
		}
	}
	await prisma.permission.createMany({ data: permissionsToCreate })
	console.timeEnd('ðŸ”‘ Created permissions...')

	console.time('ðŸ‘‘ Created roles...')
	await prisma.role.create({
		data: {
			name: 'admin',
			permissions: {
				connect: await prisma.permission.findMany({
					select: { id: true },
					where: { access: 'any' },
				}),
			},
		},
	})
	await prisma.role.create({
		data: {
			name: 'user',
			permissions: {
				connect: await prisma.permission.findMany({
					select: { id: true },
					where: { access: 'own' },
				}),
			},
		},
	})
	console.timeEnd('ðŸ‘‘ Created roles...')

	const totalUsers = 5
	console.time(`ðŸ‘¤ Created ${totalUsers} users...`)
	const userImages = await getUserImages()

	for (let index = 0; index < totalUsers; index++) {
		const userData = createUser()
		const user = await prisma.user.create({
			select: { id: true },
			data: {
				...userData,
				password: { create: createPassword(userData.username) },
				roles: { connect: { name: 'user' } },
			},
		})

		// Upload user profile image
		const userImage = userImages[index % userImages.length]
		if (userImage) {
			await prisma.userImage.create({
				data: {
					userId: user.id,
					objectKey: userImage.objectKey,
				},
			})
		}
	}
	console.timeEnd(`ðŸ‘¤ Created ${totalUsers} users...`)

	console.time('ðŸ‘‘ Created admin user "admin"')
	const adminUser = await prisma.user.create({
		select: { id: true },
		data: {
			username: 'admin',
			email: 'vazmer@gmail.com',
			name: 'Bojan Vazmer',
			password: { create: createPassword('admin1234') },
			roles: { connect: [{ name: 'admin' }, { name: 'user' }] },
		},
	})

	// Upload admin user profile image
	const adminUserImage = userImages[6]
	if (adminUserImage) {
		await prisma.userImage.create({
			data: {
				userId: adminUser.id,
				objectKey: adminUserImage.objectKey,
			},
		})
	}

	console.timeEnd('ðŸ‘‘ Created admin user "admin"')

	console.timeEnd(`ðŸŒ± Database has been seeded`)
}

seed()
	.catch((e) => {
		console.error(e)
		process.exit(1)
	})
	.finally(async () => {
		await prisma.$disconnect()
	})

// we're ok to import from the test directory in this file
/*
eslint
	no-restricted-imports: "off",
*/
